name: Tic-Tac-Toe Game

on:
  issues:
    types: [opened]

jobs:
  play:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Parse move from issue title
        id: parse
        run: |
          TITLE="${{ github.event.issue.title }}"
          MOVE="${TITLE#Move }"
          echo "MOVE=$MOVE" >> $GITHUB_ENV

      - name: Update board.json
        run: |
          FILE=".github/tictactoe/board.json"

          ROW=$(echo "$MOVE" | cut -d',' -f1)
          COL=$(echo "$MOVE" | cut -d',' -f2)
          R=$((ROW-1))
          C=$((COL-1))

          jq --argjson r $R --argjson c $C '
            if .board[$r][$c] == "" then
                .board[$r][$c] = .next
                | .next = (if .next == "X" then "O" else "X" end)
            else .
            end
          ' "$FILE" > tmp.json

          mv tmp.json "$FILE"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Pillow
        run: pip install pillow

      - name: Render board image
        run: python .github/tictactoe/render.py

      - name: Commit updated board
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/tictactoe/board.json .github/tictactoe/board.png
          git commit -m "Update Tic Tac Toe board" || echo "No changes to commit"
          git push
