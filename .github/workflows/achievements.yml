name: Update GitHub Achievements

on:
  schedule:
    - cron: "0 */12 * * *"   # Runs every 12 hours
  workflow_dispatch:          # You can also run manually

jobs:
  update-achievements:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch Achievements
        id: achievements
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ""
          plugin_achievements: yes
          plugin_achievements_display: detailed
          plugin_achievements_secrets: yes
          plugin_achievements_threshold: C        

      - name: Update README
        run: |
          README="README.md"
          START="<!-- ACHIEVEMENTS-START -->"
          END="<!-- ACHIEVEMENTS-END -->"

          # Escape the achievements output
          ACHIEVEMENTS=$(echo "${{ steps.achievements.outputs.output }}" | sed 's/"/\\"/g')

          # Replace the section
          awk -v start="$START" -v end="$END" -v replace="$ACHIEVEMENTS" '
          $0 ~ start {print; print replace; inblock=1; next}
          $0 ~ end {inblock=0}
          !inblock
          ' "$README" > temp.md

          mv temp.md "$README"

      - name: Commit & Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "âœ¨ Update achievements"
          git push
